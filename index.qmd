---
title: "Análises Descritivas do Piloto (Laura Acevedo)"
format:
  html:
    css: styles.css
---

```{r, include=FALSE}
#| label: knitr options
knitr::opts_chunk$set(results = 'asis',
                      echo = FALSE,
                      warning = FALSE,
                      tidy = FALSE,
                      message = FALSE,
                      fig.align = 'center',
                      out.width = "100%")
options(knitr.table.format = "html")
```

```{r}
#| label: packages
#| echo: false

library(tidyverse)
library(gtsummary)
library(modelsummary)
library(jtools)
library(ggstatsplot)
library(labelled)
library(glue)
library(correlation)
library(GGally)
library(jtools)
library(reactable)
library(easystats)
library(broom)
library(gt)
library(kableExtra)
library(officer)
library(huxtable)
library(flextable)
library(summarytools)
library(cardx)
library(broom)
```

```{r}
#| echo: false
df <- readRDS(file = "data_private/df_final.RDS")

df_select <- df |> 
     select(c(
            idade, 
            dplyr::ends_with("rec"),
            dplyr::ends_with("rec2"),
            dplyr::contains("gad"),
            dplyr::contains("igi"),
            dplyr::contains("phq"),
            alcool, tabaco,
            dplyr::contains("emocional")
            ))
```

# Análise Descritiva

```{r}
#| label: tbl1 english labels
#| echo: false
# A named vector: variable names = table 1 labels
variaveis_labels <- c(
  # Categorical Variables
  sexo_rec = "Sex",
  raca_rec = "Race",
  escolaridade_rec2 = "Education",
  estado_civil_rec2 = "Marital Status",
  tipo_moradia_rec2 = "Housing Type",
  situacao_ocupacional_rec2 = "Employment Status",
  idade = "Age",
  renda_rec2 = "Income",
  suporte_social_rec = "Social Support (company)",
  suporte_social2_rec = "Social Support (emotional support)",
  alcool = "Alcohol Use", 
  tabaco = "Tobacco Use",
  phq9_cat_rec = "PHQ-9 (categories)",
  igi_cat_rec = "IGI (categories)",
  gad7_cat_rec = "GAD-7 (categories)",
  tratamento_emocional_hist = "Psychological/Psychiatric Treatment (history)", 
  tratamento_emocional_atual = "Psychological/Psychiatric Treatment (current)",
  medicamento_emocional_atual = "Medication Use (emotional symptoms)",
  
  # Numeric Variables
  score_phq = "PHQ-9 Score",
  score_igi = "IGI Score",
  score_gad = "GAD-7 Score",
  igi_cat_vd = "ISI (DV)"
)

# Now combine everything:
df_select_ordered <- df_select |>
  select(all_of(names(variaveis_labels))) |>   # select in the specified order
  set_variable_labels(.labels = variaveis_labels)  # apply labels at once
```

```{r}
#| label: tabela 1 & 2 - pacote {gtsummary}

tbl1 <- df_select_ordered |> 
     select(sexo_rec:tabaco, igi_cat_vd) |> 
     tbl_summary(
          by = igi_cat_vd,
          statistic = list(
               all_continuous() ~ "{mean} ({sd}) ({min}-{max})",
               all_categorical() ~ "{n} ({p}%)"), 
          digits = all_continuous() ~ 2,
          missing = "no") |> 
        add_p() |> 
     bold_labels() |> 
     modify_header(label = "**Variável**")

tbl2 <- df_select_ordered |> 
     select(phq9_cat_rec:dplyr::last_col(), igi_cat_vd) |> 
     tbl_summary(
          by = igi_cat_vd,
          statistic = list(
               all_continuous() ~ "{mean} ({sd}) ({min}-{max})",
               all_categorical() ~ "{n} ({p}%)"), 
          digits = all_continuous() ~ 2,
          missing = "no") |> 
        add_p() |> 
     bold_labels() |> 
     modify_header(label = "**Variável**")

tbl1 |> 
     as_gt() |>
     gt::gtsave(filename = "output/table1.docx")

tbl2 |> 
     as_gt() |>
     gt::gtsave(filename = "output/table2.docx")

tbl1
tbl2
```

```{r}
#| label: gráfico das proporções em cada cutoff dos IGI, PHQ e GAD

df_long <- df_select_ordered |>
  select(phq9_cat_rec, igi_cat_rec, gad7_cat_rec) |>
  pivot_longer(
    cols = everything(),
    names_to = "instrumento",
    values_to = "categoria"
  ) |>
  mutate(
    instrumento = recode(instrumento,
                         "phq9_cat_rec" = "PHQ-9",
                         "igi_cat_rec" = "IGI",
                         "gad7_cat_rec" = "GAD-7"),
    categoria = as.factor(categoria), # forçar como texto
    categoria = fct_relevel(categoria, c("Nenhum/Leve", "Mínimo","Leve",  "Moderado", "Moderadamente Grave", "Grave"))
  )

ggplot(df_long, aes(x = categoria, fill = instrumento)) +
  geom_bar(position = "dodge") +
  facet_wrap(~ instrumento, scales = "free_x") +
  labs(
    title = "Distribuição das categorias por instrumento",
    x = "Categoria",
    y = "Frequência"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Correlação

```{r}
#| label: correlação

library(dplyr)
library(correlation)
library(gt)

# labels
num_labels <- c(
  idade      = "AGE",
  score_phq  = "PHQ-9",
  score_igi  = "ISI",
  score_gad  = "GAD-7"
)

# select
df_corr <- df_select_ordered |>
  select(all_of(names(num_labels)))

# correlations
res <- correlation(df_corr, method = "pearson", ci = 0.95)

# format + add labels
res_fmt <- res |>
  mutate(
    var1 = unname(num_labels[Parameter1]),
    var2 = unname(num_labels[Parameter2]),
    r_ci = sprintf("%.2f (%.2f, %.2f)", r, CI_low, CI_high),
    p = sprintf("%.3f", p)
  ) |>
  select(
    `Variable 1` = var1,
    `Variable 2` = var2,
    r_ci,
    p
  )

# add stars
res_stars <- res_fmt |>
  mutate(
    stars = case_when(
      as.numeric(p) < 0.001 ~ "***",
      as.numeric(p) < 0.01  ~ "**",
      as.numeric(p) < 0.05  ~ "*",
      TRUE ~ ""
    ),
    `Correlation (95% CI)` = paste0(r_ci, stars)
  ) |>
  select(
    `Variable 1`,
    `Variable 2`,
    `Correlation (95% CI)`,
    p
  )

tab_corr <- res_stars |>
  gt() |>
  tab_header("Pearson correlations with 95% confidence intervals") |>
  tab_source_note(
    "*p < 0.05; **p < 0.01; ***p < 0.001.  
    Abbreviations: PHQ-9, Patient Health Questionnaire-9;  
    ISI, Insomnia Severity Index;  
    GAD-7, Generalized Anxiety Disorder-7."
  )

gt::gtsave(tab_corr, "output/table_corr.docx")

# 1) Rodar todos os testes de correlação
tests <- list(
  r1 = cor.test(df_corr$idade,      df_corr$score_phq),
  r2 = cor.test(df_corr$idade,      df_corr$score_igi),
  r3 = cor.test(df_corr$idade,      df_corr$score_gad),
  r4 = cor.test(df_corr$score_phq,  df_corr$score_igi),
  r5 = cor.test(df_corr$score_gad,  df_corr$score_igi)
)

# 2) Extrair p-values originais
p_raw  <- sapply(tests, function(x) x$p.value)

# 3) Ajustar com Holm
p_holm <- p.adjust(p_raw, method = "holm")

# 4) Substituir o p.value de cada teste pelo valor ajustado
for (i in seq_along(tests)) {
  tests[[i]]$p.value <- p_holm[i]
}

# 5) Gerar os textos com report() já usando p Holm-ajustado
reports_txt <- lapply(tests, report)

doc <- read_docx("output/table_corr.docx") |>
  # nota geral sobre o ajuste
  body_add_par("P-values were adjusted for multiple comparisons using Holm's method.", style = "Normal")

# adicionar cada texto de correlação
for (txt in reports_txt) {
  doc <- body_add_par(doc, txt, style = "Normal")
}

print(doc, target = "output/table_corr.docx")

res
reports_txt
```

```{r}
#| label: tabelas-reg-completo
#| eval: false
#| echo: false

# 1) vetor das IVs categóricas
vars_cat <- df_select_ordered |>  
  select(!where(is.numeric))  |>  
  select(-matches("igi_cat_rec|gad7_cat_rec|phq9_cat_rec", ignore.case = TRUE)) |>  
  names()

# 2) vetor dos scores numéricos
dvs <- c("score_igi", "score_gad", "score_phq")

# 3) função que roda lm(Y ~ X) para cada IV (incluindo os dois scores que não sejam Y)
table_regression <- function(y_name, data = df_select_ordered) {
  
  # combinar categóricas + scores (tirando a própria DV)
  ivs <- c(vars_cat, setdiff(dvs, y_name))
  
  # ajustar cada modelo e extrair tidy + glance
  res <- map_dfr(ivs, function(iv_var) {
    mdl <- lm(as.formula(paste(y_name, "~", iv_var)), data = data)
    td  <- tidy(mdl, conf.int = TRUE) %>% filter(term != "(Intercept)")
    gl  <- glance(mdl)
    
    td %>% 
      mutate(
        iv         = iv_var,
        estimate   = sprintf(
                       "%.2f%s [%.2f, %.2f]",
                       estimate,
                       case_when(
                         p.value < .01 ~ "**",
                         p.value < .05 ~ "*",
                         TRUE          ~ ""
                       ),
                       conf.low,
                       conf.high
                     ),
        p_value    = sprintf("%.3f", p.value),
        N          = gl$nobs,
        R2         = round(gl$r.squared, 3)
      )
  })
  
  # montar a tabela GT
  res %>% 
    select(iv, term, estimate, p_value, N, R2) |>  
    gt(rowname_col = "iv") |>  
    tab_header(title = glue("Regressões: DV = {y_name}")) %>% 
    cols_label(
      iv         = "Variável",
      term       = "Termo",
      estimate   = "β [IC 95%]",
      p_value    = "p-valor",
      N          = "N",
      R2         = "R²"
    )
}
```

```{r}
#| echo: false
#| results: asis
#| eval: false

table_regression("score_igi")
```

```{r}
#| echo: false
#| results: asis
#| eval: false

table_regression("score_gad")
```

```{r}
#| eval: false
#| echo: false
#| results: asis
table_regression("score_phq")
```

```{r}
#| label: logit-univ-final
#| eval: false
#| echo: false
#| results: asis
#| warning: false
#| message: false

# 0) garantir que DV seja binária
df <- df_select_ordered %>% 
  mutate(igi_cat_vd = factor(igi_cat_vd, levels = c("Não Insone","Insone")))

# 1) vetor das IVs
ivs <- df %>% 
  select(
    !where(is.numeric),
    -matches("igi_cat_rec|gad7_cat_rec|phq9_cat_rec|igi_cat_vd", ignore.case = TRUE)
  ) %>% 
  names()

# 2) para cada IV, ajustar glm univariado e empilhar resultados
tab_log <- map_dfr(ivs, function(iv) {
  # ajuste
  mdl <- glm(
    formula = as.formula(glue("igi_cat_vd ~ {iv}")),
    data    = df,
    family  = binomial(link = "logit")
  )
  # tidy com OR e IC
  td <- tidy(mdl, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(term != "(Intercept)")
  gl <- glance(mdl)
  
  # montar tibble com Variável, Categoria e indicadores
  td %>%
    transmute(
      Variável  = iv,
      Categoria = str_remove(term, paste0("^", iv)),
      OR_num    = estimate,
      CI_low    = conf.low,
      CI_high   = conf.high,
      pval_num  = p.value,
      N         = gl$nobs,
      `Pseudo R²` = round(1 - gl$deviance / gl$null.deviance, 3),
      AIC       = round(AIC(mdl), 1),
      BIC       = round(BIC(mdl), 1)
    ) %>%
    mutate(
      # formata OR + estrelas
      sig   = case_when(
                pval_num < 0.001 ~ "***",
                pval_num < 0.01  ~ "**",
                pval_num < 0.05  ~ "*",
                TRUE             ~ ""
              ),
      OR    = sprintf("%.2f%s", OR_num, sig),
      `IC 95%`  = sprintf("[%.2f, %.2f]", CI_low, CI_high),
      `p-valor` = if_else(pval_num < 0.001, "< .001", sprintf("%.3f", pval_num))
    ) %>%
    select(Variável, Categoria, OR, `IC 95%`, `p-valor`, N, `Pseudo R²`, AIC, BIC)
})

# 3) renderizar com GT
tab_log %>%
  gt() %>%
  tab_header("Logistic Regression (univariada) — DV = igi_cat_vd") %>%
  cols_label(
    Variável  = "Variável",
    Categoria = "Categoria",
    OR        = "OR",
    `IC 95%`  = "IC 95%",
    `p-valor` = "p-valor",
    N         = "N",
    `Pseudo R²` = "Pseudo R²",
    AIC       = "AIC",
    BIC       = "BIC"
  )
```

# Regressões Linear Múltipla

```{r}
step1 <- lm(score_igi ~ sexo_rec + raca_rec + score_phq + score_gad,
            data = df_select_ordered)

step_regression <- modelsummary(
  models   = list("Step 1" = step1),
  estimate = "{estimate}{stars} [{conf.low}, {conf.high}]",
  stars    = c('*' = .05, '**' = .01),
  statistic = NULL,
  gof_omit  = 'Log.Lik|RMSE',
  fmt       = 2,
  output    = "gt"
)

gt::gtsave(step_regression, filename = "output/multiple_regression.docx")

report1 <- report::report(step1)
check1  <- performance::check_model(step1)

# Text from report()
report1_text <- as.character(report1)

doc <- read_docx("output/multiple_regression.docx") |>
  body_add_par(value = "Regression report", style = "heading 1") |>
  body_add_par(value = report1_text, style = "Normal")

print(doc, target = "output/multiple_regression_full.docx")

step_regression
report1
check1
```
