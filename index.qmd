---
title: "Análises Descritivas do Piloto (Laura Acevedo)"
format:
  html:
    css: styles.css
---

```{r, include=FALSE}
#| label: knitr options
knitr::opts_chunk$set(results = 'asis',
                      echo = FALSE,
                      warning = FALSE,
                      tidy = FALSE,
                      message = FALSE,
                      fig.align = 'center',
                      out.width = "100%")
options(knitr.table.format = "html")
```

```{r}
#| label: packages
#| echo: false

library(tidyverse)
library(gtsummary)
library(modelsummary)
library(jtools)
library(ggstatsplot)
library(labelled)
library(glue)
library(correlation)
library(GGally)
library(jtools)
library(reactable)
library(easystats)
library(broom)
library(gt)
library(kableExtra)
```

```{r}
#| echo: false
df <- readRDS(file = "data_private/df_final.RDS")

df_select <- df |> 
     select(c(
            idade, 
            dplyr::ends_with("rec"),
            dplyr::ends_with("rec2"),
            dplyr::contains("gad"),
            dplyr::contains("igi"),
            dplyr::contains("phq"),
            alcool, tabaco,
            dplyr::contains("emocional")
            ))
```

# Análise Descritiva

```{r}
#| label: sequencia das variáveis na tabela 1
#| echo: false
# Um vetor nomeado: nomes das variáveis = label tabela 1
variaveis_labels <- c(
  # Variáveis Categóricas
  sexo_rec = "Sexo",
  raca_rec = "Raça",
  escolaridade_rec2 = "Escolaridade",
  estado_civil_rec2 = "Estado Civil",
  tipo_moradia_rec2 = "Moradia",
  situacao_ocupacional_rec2 = "Situação Ocupacional",
  renda_rec2 = "Renda",
  suporte_social_rec = "Suporte Social (companhia)",
  suporte_social2_rec = "Suporte Social (apoio)",
  alcool = "Uso de Alcool", 
  tabaco = "Uso de Tabaco",
  phq9_cat_rec = "PHQ-9 (categorias)",
  igi_cat_rec = "IGI (categorias)",
  gad7_cat_rec = "GAD-7 (categorias)",
  tratamento_emocional_hist = "Tratamento Psico/Psiq (histórico)", 
  tratamento_emocional_atual = "Tratamento Psico/Psiq (atual)",
  medicamento_emocional_atual = "Uso de Medicamentos (sintomas emocionais)",
  

  
  # Variáveis Numéricas
  idade = "Idade",
  score_phq = "PHQ-9",
  score_igi = "IGI",
  score_gad = "GAD-7",
  igi_cat_vd = "Igi (VD)"
)

# Agora você faz tudo junto:
df_select_ordered <- df_select |>
  select(all_of(names(variaveis_labels))) |>   # seleciona na ordem
  set_variable_labels(.labels = variaveis_labels)  # aplica labels de uma vez
```

```{r}
#| label: pacote {gtsummary}
table_descriptives <- df_select_ordered |>
     tbl_summary(
          statistic = list(
               all_continuous() ~ "{mean} ({sd}) ({min}-{max})",
               all_categorical() ~ "{n} ({p}%)"), 
          digits = all_continuous() ~ 2,
          missing = "no") |> 
     bold_labels() |> 
     modify_header(label = "**Variável**")

table_descriptives

table_descriptives |> 
     as_gt() |>
     gt::gtsave(filename = "output/table1_2.docx")
```

```{r}
#| lable: gráfico

# Pivot mais limpa
df_long <- df_select_ordered |>
  select(phq9_cat_rec, igi_cat_rec, gad7_cat_rec) |>
  pivot_longer(
    cols = everything(),
    names_to = "instrumento",
    values_to = "categoria"
  ) |>
  mutate(
    instrumento = recode(instrumento,
                         "phq9_cat_rec" = "PHQ-9",
                         "igi_cat_rec" = "IGI",
                         "gad7_cat_rec" = "GAD-7"),
    categoria = as.factor(categoria), # forçar como texto!
    categoria = fct_relevel(categoria, c("Nenhum/Leve", "Mínimo","Leve",  "Moderado", "Moderadamente Grave", "Grave"))
  )

ggplot(df_long, aes(x = categoria, fill = instrumento)) +
  geom_bar(position = "dodge") +
  facet_wrap(~ instrumento, scales = "free_x") +
  labs(
    title = "Distribuição das categorias por instrumento",
    x = "Categoria",
    y = "Frequência"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Correlação

```{r}
#| label: correlação

ggcorr(df_select_ordered, 
       low = "#F21A00", 
       mid = "#EEEEEE", 
       high = "#3B9AB2",
       name = "Correlação 
de Pearson
", 
       label = TRUE,
       label_size = 4,
       label_alpha = TRUE,
       hjust = 0.58, 
       size = 4, 
       color = "grey50")

# Tabelinha com Estrelas
table_correlation <- datasummary_correlation(df_select_ordered)

fun = function(x) {
    out = correlation(x)
    stars = c('*' =.05, '**' = .01)
    p = modelsummary:::make_stars(out$p, stars)
    out$r = sprintf("%.2f%s", out$r, p)
    out = as.matrix(out)
    return(out)
}

table_correlation_stars <- datasummary_correlation(df_select_ordered, method = fun, )

table_correlation_stars
```

```{r}
#| results: markup
# Report dos resultados
cor.test(df_select_ordered$score_phq, df_select_ordered$score_igi, use = "complete.obs") |> report() |> print()

cor.test(df_select_ordered$score_gad, df_select_ordered$score_igi, use = "complete.obs") |> report() |> print()

cor.test(df_select_ordered$score_gad, df_select_ordered$score_phq, use = "complete.obs") |> report() |> print()
```

# Tabelas Regressão Linear

```{r}
#| label: tabelas-reg-completo
#| echo: false
#| results: asis

# 1) vetor das IVs categóricas
vars_cat <- df_select_ordered |>  
  select(!where(is.numeric))  |>  
  select(-matches("igi_cat_rec|gad7_cat_rec|phq9_cat_rec", ignore.case = TRUE)) |>  
  names()

# 2) vetor dos scores numéricos
dvs <- c("score_igi", "score_gad", "score_phq")

# 3) função que roda lm(Y ~ X) para cada IV (incluindo os dois scores que não sejam Y)
table_regression <- function(y_name, data = df_select_ordered) {
  
  # combinar categóricas + scores (tirando a própria DV)
  ivs <- c(vars_cat, setdiff(dvs, y_name))
  
  # ajustar cada modelo e extrair tidy + glance
  res <- map_dfr(ivs, function(iv_var) {
    mdl <- lm(as.formula(paste(y_name, "~", iv_var)), data = data)
    td  <- tidy(mdl, conf.int = TRUE) %>% filter(term != "(Intercept)")
    gl  <- glance(mdl)
    
    td %>% 
      mutate(
        iv         = iv_var,
        estimate   = sprintf(
                       "%.2f%s [%.2f, %.2f]",
                       estimate,
                       case_when(
                         p.value < .01 ~ "**",
                         p.value < .05 ~ "*",
                         TRUE          ~ ""
                       ),
                       conf.low,
                       conf.high
                     ),
        p_value    = sprintf("%.3f", p.value),
        N          = gl$nobs,
        R2         = round(gl$r.squared, 3)
      )
  })
  
  # montar a tabela GT
  res %>% 
    select(iv, term, estimate, p_value, N, R2) |>  
    gt(rowname_col = "iv") |>  
    tab_header(title = glue("Regressões: DV = {y_name}")) %>% 
    cols_label(
      iv         = "Variável",
      term       = "Termo",
      estimate   = "β [IC 95%]",
      p_value    = "p-valor",
      N          = "N",
      R2         = "R²"
    )
}
```

## Preditores do IGI

```{r}
#| echo: false
#| results: asis
table_regression("score_igi")
```

## Preditores do GAD-7

```{r}
#| echo: false
#| results: asis
table_regression("score_gad")
```

## Preditores do PHQ-9

```{r}
#| echo: false
#| results: asis
table_regression("score_phq")
```

# Tabela Regressão Logística

-   Não insone = IGI \< 15

-   Insone = IGI \>= 15

```{r}
#| label: logit-univ-final
#| echo: false
#| results: asis
#| warning: false
#| message: false

# 0) garantir que DV seja binária
df <- df_select_ordered %>% 
  mutate(igi_cat_vd = factor(igi_cat_vd, levels = c("Não Insone","Insone")))

# 1) vetor das IVs
ivs <- df %>% 
  select(
    !where(is.numeric),
    -matches("igi_cat_rec|gad7_cat_rec|phq9_cat_rec|igi_cat_vd", ignore.case = TRUE)
  ) %>% 
  names()

# 2) para cada IV, ajustar glm univariado e empilhar resultados
tab_log <- map_dfr(ivs, function(iv) {
  # ajuste
  mdl <- glm(
    formula = as.formula(glue("igi_cat_vd ~ {iv}")),
    data    = df,
    family  = binomial(link = "logit")
  )
  # tidy com OR e IC
  td <- tidy(mdl, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(term != "(Intercept)")
  gl <- glance(mdl)
  
  # montar tibble com Variável, Categoria e indicadores
  td %>%
    transmute(
      Variável  = iv,
      Categoria = str_remove(term, paste0("^", iv)),
      OR_num    = estimate,
      CI_low    = conf.low,
      CI_high   = conf.high,
      pval_num  = p.value,
      N         = gl$nobs,
      `Pseudo R²` = round(1 - gl$deviance / gl$null.deviance, 3),
      AIC       = round(AIC(mdl), 1),
      BIC       = round(BIC(mdl), 1)
    ) %>%
    mutate(
      # formata OR + estrelas
      sig   = case_when(
                pval_num < 0.001 ~ "***",
                pval_num < 0.01  ~ "**",
                pval_num < 0.05  ~ "*",
                TRUE             ~ ""
              ),
      OR    = sprintf("%.2f%s", OR_num, sig),
      `IC 95%`  = sprintf("[%.2f, %.2f]", CI_low, CI_high),
      `p-valor` = if_else(pval_num < 0.001, "< .001", sprintf("%.3f", pval_num))
    ) %>%
    select(Variável, Categoria, OR, `IC 95%`, `p-valor`, N, `Pseudo R²`, AIC, BIC)
})

# 3) renderizar com GT
tab_log %>%
  gt() %>%
  tab_header("Logistic Regression (univariada) — DV = igi_cat_vd") %>%
  cols_label(
    Variável  = "Variável",
    Categoria = "Categoria",
    OR        = "OR",
    `IC 95%`  = "IC 95%",
    `p-valor` = "p-valor",
    N         = "N",
    `Pseudo R²` = "Pseudo R²",
    AIC       = "AIC",
    BIC       = "BIC"
  )
```
